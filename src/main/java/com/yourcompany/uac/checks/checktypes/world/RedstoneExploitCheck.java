package com.yourcompany.uac.checks.checktypes.world;

import com.yourcompany.uac.UltimateAntiCheatPlugin;
import com.yourcompany.uac.checks.AbstractCheck;
import com.yourcompany.uac.checks.context.RedstoneContext;
import com.yourcompany.uac.config.Settings;

/**
 * Flags potential redstone lag machines by monitoring the rate of updates per
 * player in a small region.
 */
public class RedstoneExploitCheck extends AbstractCheck {

    public RedstoneExploitCheck(UltimateAntiCheatPlugin plugin) {
        super(plugin, "RedstoneExploitCheck");
    }

    @Override
    public void handle(Object context) {
        if (!(context instanceof RedstoneContext redstone)) {
            return;
        }
        Settings settings = plugin.getConfigManager().getSettings();
        if (!settings.redstoneEnabled) {
            return;
        }

        if (redstone.getUpdates() > settings.maxRedstoneUpdatesPerTick) {
            flag(redstone.getPlayer(), "Redstone spike: " + redstone.getUpdates() + " updates", redstone.getPosition(),
                    settings.redstoneSeverity);
            if (settings.enableRedstoneMitigation) {
                plugin.getIntegrationService().getMitigationActions().clearEntitiesNear(redstone.getPlayer(), getCheckName(), 12, "Redstone spike");
                plugin.getIntegrationService().getMitigationActions().throttle(redstone.getPlayer(), getCheckName(), "Redstone spike");
            }
        }
    }
}
